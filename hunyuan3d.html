<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 3D åˆ›ä½œ - è…¾è®¯æ··å…ƒç”Ÿ3D</title>
<link rel="icon" type="image/png" href="image/image.png">

<style>
/*========== åŸºç¡€ & ä¸»é¢˜ ==========*/
* { margin: 0; padding: 0; box-sizing: border-box; }
html,body{ height:auto; min-height:100vh; }
body{
  font-family: 'Microsoft YaHei','å¾®è½¯é›…é»‘','STKaiti',serif;
  background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color: #e0f7fa; padding: 60px 20px 40px; position: relative;
}
body::before{ /* è£…é¥°å…‰æ–‘ */
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(circle at 20% 80%,rgba(255,255,255,.08) 0%,transparent 50%),
              radial-gradient(circle at 80% 20%,rgba(255,255,255,.08) 0%,transparent 50%);
  pointer-events: none;
}
.container{ max-width: 1000px; margin: 0 auto; text-align: center; position: relative; }

/*========== æ ‡é¢˜ ==========*/
h1{ font-size: clamp(32px,5vw,48px); margin-bottom: 10px;
    background: linear-gradient(45deg,#4fc3f7,#29b6f6,#03a9f4);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 4px; }
.subtitle{ font-size: clamp(14px,2.5vw,18px); margin-bottom: 40px; letter-spacing: 2px; color: #bbdefb; }

/*========== è¾“å…¥å¡ç‰‡ ==========*/
.input-section{ background: rgba(255,255,255,.08); border-radius: 15px; padding: 30px;
                border: 1px solid rgba(255,255,255,.1); backdrop-filter: blur(10px); margin-bottom: 30px; }
.input-section h3{ color: #4fc3f7; margin-bottom: 20px; font-size: 24px; }

textarea{ width: 100%; padding: 15px; border: 2px solid rgba(79,195,247,.3); border-radius: 10px;
          background: rgba(0,0,0,.2); color: #e0f7fa; font-size: 16px; resize: vertical; min-height: 120px; font-family: inherit; }
textarea:focus{ outline: none; border-color: #4fc3f7; box-shadow: 0 0 15px rgba(79,195,247,.3); }

/*========== ä¸Šä¼  & é¢„è§ˆ ==========*/
.file-upload{ margin: 20px 0; text-align: left; }
.file-upload label{ display: block; margin-bottom: 10px; color: #bbdefb; font-size: 16px; }
input[type=file]{
  display: block; width: 100%; padding: 10px; border: 2px dashed rgba(79,195,247,.5);
  border-radius: 8px; background: rgba(0,0,0,.2); color: #e0f7fa; cursor: pointer;
}
input[type=file]:hover:not(:disabled){ border-color: #4fc3f7; }
input[type=file]:disabled{ border-color: #666; cursor: not-allowed; }

.preview-img{ max-width: 300px; max-height: 200px; border-radius: 10px;
              margin: 15px auto; box-shadow: 0 4px 15px rgba(0,0,0,.3); display: block; }

/*========== æŒ‰é’® ==========*/
.submit-btn{ width: 100%; padding: 16px; border: none; border-radius: 10px;
             background: linear-gradient(45deg,#2196f3,#21cbf3); color: #042b3a;
             font-size: 18px; font-weight: bold; cursor: pointer; transition: all .3s ease; margin-top: 20px; }
.submit-btn:hover:not(:disabled){ transform: translateY(-3px);
                                  box-shadow: 0 6px 20px rgba(33,150,243,.5); }
.submit-btn:disabled{ background: #666; cursor: not-allowed; }

/*========== çŠ¶æ€ & ç»“æœ ==========*/
.status-section{ background: rgba(255,255,255,.05); border-radius: 15px;
                 padding: 25px; border: 1px solid rgba(255,255,255,.1); margin-top: 20px; }
.status-section h3{ color: #4fc3f7; margin-bottom: 20px; }
.status-badge{ display: inline-block; padding: 8px 20px; border-radius: 25px;
               font-weight: bold; color: white; margin: 10px 0; }
.status-badge.WAIT{ background: #faad14; }
.status-badge.RUN{ background: #2196f3; }
.status-badge.DONE{ background: #52c41a; }
.status-badge.FAIL{ background: #ff4d4f; }
.progress-bar{ width: 100%; height: 10px; background: rgba(255,255,255,.1);
               border-radius: 5px; overflow: hidden; margin: 15px 0; }
.progress{ height: 100%; background: linear-gradient(90deg,#2196f3,#21cbf3);
           transition: width .3s ease; }
.error-box{ background: rgba(255,77,79,.1); border: 1px solid #ff4d4f;
            color: #ff4d4f; padding: 15px; border-radius: 8px; margin: 15px 0; }

.results{ margin-top: 25px; }
.results h3{ color: #52c41a; margin-bottom: 20px; }
.file-card{ background: rgba(255,255,255,.05); border: 1px solid rgba(82,196,26,.3);
            border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.result-preview{ max-width: 100%; max-height: 300px; border-radius: 8px;
                 margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,.2); }
.file-info{ display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.file-type{ font-size: 18px; font-weight: bold; color: #52c41a; }
.download-link{ padding: 10px 20px; background: linear-gradient(45deg,#52c41a,#73d13d);
                color: #042b3a; text-decoration: none; border-radius: 6px; font-weight: bold;
                transition: all .3s; }
.download-link:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(82,196,26,.4); }

/*========== è¾…åŠ© ==========*/
code{ background: rgba(0,0,0,.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #4fc3f7; }
.btn{ display: inline-block; background: linear-gradient(45deg,#2196f3,#21cbf3);
      color: #042b3a; padding: 12px 30px; border-radius: 25px; text-decoration: none;
      font-weight: bold; transition: all .3s ease; box-shadow: 0 4px 15px rgba(33,150,243,.3); }
.btn:hover{ transform: translateY(-2px); box-shadow: 0 6px 20px rgba(33,150,243,.4); }
.warning-box{ background: rgba(255,152,0,.1); border: 1px solid #ff9800;
              color: #ff9800; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 14px; }
.file-validation-error{ background: rgba(255,77,79,.1); border: 1px solid #ff4d4f;
                        color: #ff4d4f; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 14px; }
</style>

</head>

<body>
<script type="text/javascript" src="scaler/js/canvas-nest.min.js"></script>
<div class="container" id="app">
  <h1>AI 3D åˆ›ä½œ</h1>
  <p class="subtitle">è…¾è®¯æ··å…ƒç”Ÿ3D - æ–‡å­—ä¸å›¾ç‰‡ç”Ÿæˆ3Dæ¨¡å‹</p>

  <!-- è¾“å…¥åŒº -->
  <div class="input-section">
    <h3>ğŸ¨ åˆ›ä½œè®¾ç½®</h3>

    <!-- æ–‡å­—æè¿° -->
    <textarea v-model="prompt" rows="4"
              placeholder="è¾“å…¥æè¿°ï¼Œä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„å¡é€šçŒ«ï¼Œå…¨èº«ï¼Œ3Dé£æ ¼ï¼Œè‰²å½©é²œè‰³ï¼ˆå¯é€‰ï¼‰"></textarea>

    <!-- çº¯å›¾ç‰‡æç¤º -->
    <div v-if="!prompt.trim() && imagePreview" class="warning-box">
      âš ï¸ æœªè¾“å…¥æ–‡å­—æè¿°ï¼Œä»…ä½¿ç”¨å›¾ç‰‡ç”Ÿæˆï¼ˆå»ºè®®è¡¥å……æè¿°ä»¥æå‡æ•ˆæœï¼‰
    </div>

    <!-- ä¸Šä¼  & é¢„è§ˆ -->
    <div class="file-upload">
      <label for="imageInput">ğŸ“· æˆ–ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œæœ€å¤§ 5 MBï¼‰ï¼š</label>
      <input type="file" id="imageInput"
             accept="image/jpeg,image/png,image/webp"
             :disabled="isProcessing"
             @change="handleImage">
      <!-- é”™è¯¯æç¤º -->
      <div v-if="imageError" class="file-validation-error">âŒ {{ imageError }}</div>
      <!-- ç¼©ç•¥å›¾ -->
      <img v-if="imagePreview" :src="imagePreview" class="preview-img">
      <!-- æ¸…ç©º -->
      <button v-if="imagePreview" @click="clearImage" class="btn"
              style="margin-top:10px;background:#ff9800;color:#042b3a;">
        æ¸…ç©ºå›¾ç‰‡
      </button>
    </div>

    <!-- æäº¤ -->
    <button @click="submitJob" class="submit-btn"
            :disabled="!canSubmit || isProcessing">
      {{ isProcessing ? 'â³ ç”Ÿæˆä¸­...' : 'ğŸš€ ç”Ÿæˆ3Dæ¨¡å‹' }}
    </button>
  </div>

  <!-- çŠ¶æ€ / è¿›åº¦ -->
  <div v-if="jobId" class="status-section">
    <h3>ğŸ“Š ä»»åŠ¡çŠ¶æ€</h3>
    <p>ä»»åŠ¡ID: <code>{{ jobId }}</code></p>
    <div class="status-badge" :class="status">{{ statusText }}</div>

    <div v-if="status==='WAIT' || status==='RUN'" class="progress-bar">
      <div class="progress" :style="{width: progress+'%'}"></div>
    </div>

    <div v-if="status==='FAIL'" class="error-box">
      <strong>ç”Ÿæˆå¤±è´¥ï¼š</strong>{{ errorMessage }}
    </div>
  </div>

  <!-- ç»“æœ -->
  <div v-if="status==='DONE'" class="results">
    <h3>ğŸ‰ æ¨¡å‹ç”ŸæˆæˆåŠŸï¼</h3>
    <div v-for="f in resultFiles" :key="f.url" class="file-card">
      <img :src="f.previewUrl" class="result-preview">
      <div class="file-info">
        <span class="file-type">{{ f.type }} æ ¼å¼</span>
        <a :href="f.url" target="_blank" class="download-link">â¬‡ï¸ ä¸‹è½½æ¨¡å‹</a>
      </div>
    </div>
  </div>

  <!-- è¿”å› -->
  <div style="margin-top: 30px;">
    <a href="index.html" class="btn">è¿”å›é¦–é¡µ</a>
  </div>
</div>

<!-- Vue 3 + Axios CDN -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
const { createApp, ref, computed } = Vue;

createApp({
  setup(){
    /*========== åŸºç¡€æ•°æ® ==========*/
    const prompt        = ref('');
    const imageFile     = ref(null);          // File å¯¹è±¡
    const imagePreview  = ref('');            // DataURL ä¾› img æ˜¾ç¤º
    const imageError    = ref('');            // ä¸Šä¼ é”™è¯¯æç¤º
    const jobId         = ref('');
    const status        = ref('');            // WAIT / RUN / DONE / FAIL
    const errorMessage  = ref('');
    const resultFiles   = ref([]);
    const isProcessing  = ref(false);
    const progress      = ref(0);

    /*========== è®¡ç®—å±æ€§ ==========*/
    const canSubmit = computed(()=> prompt.value.trim() || imageFile.value);
    const statusText= computed(()=>{
      const map={ WAIT:'â³ ç­‰å¾…ä¸­',RUN:'ğŸ”„ ç”Ÿæˆä¸­',DONE:'âœ… å®Œæˆ',FAIL:'âŒ å¤±è´¥' };
      return map[status.value]||'æœªçŸ¥';
    });

    /*========== ä¸Šä¼  & é¢„è§ˆ ==========*/
    const MAX_SIZE = 5*1024*1024, MAX_DIM=2048, ALLOW=['image/jpeg','image/png','image/webp'];

    function clearImage(){
      imageFile.value=null; imagePreview.value=''; imageError.value='';
      document.getElementById('imageInput').value='';
    }
    function handleImage(e){
      const file=e.target.files[0];
      if(!file){clearImage();return;}
      // é˜²ç©º
      if(!ALLOW.includes(file.type)){imageError.value='ä»…æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼';e.target.value='';return;}
      if(file.size>MAX_SIZE){imageError.value='å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5 MB';e.target.value='';return;}
      const img=new Image();
      img.onload=()=>{
        if(img.width>MAX_DIM||img.height>MAX_DIM){imageError.value=`å›¾ç‰‡å°ºå¯¸è¿‡å¤§ï¼š${img.width}Ã—${img.height}ï¼ˆæœ€å¤§ ${MAX_DIM}pxï¼‰`;e.target.value='';return;}
        imageFile.value=file;
        imagePreview.value=img.src;          // å±•ç¤ºç¼©ç•¥å›¾
        imageError.value='';
      };
      img.onerror=()=>{imageError.value='å›¾ç‰‡æ–‡ä»¶æŸåæˆ–æ— æ³•è¯»å–';e.target.value='';};
      const reader=new FileReader();
      reader.onload=ev=>img.src=ev.target.result;
      reader.readAsDataURL(file);
    }

    /*========== æäº¤ä»»åŠ¡ ==========*/
    async function submitJob(){
      if(!canSubmit.value){alert('è¯·è¾“å…¥æè¿°æˆ–ä¸Šä¼ å›¾ç‰‡');return;}
      isProcessing.value=true; progress.value=5;

      let imageBase64='';
      if(imageFile.value){
        imageBase64=await new Promise(r=>{
          const rd=new FileReader();
          rd.onload=e=>r(e.target.result);
          rd.readAsDataURL(imageFile.value);
        });
      }
      try{
        const {data}=await axios.post('/api/hunyuan3d/submit',{prompt:prompt.value,image:imageBase64});
        if(data.success){
          jobId.value=data.jobId; status.value='WAIT';
          if(data.inputType==='image_only')progress.value=15;
          queryResult();
        }else{
          alert('æäº¤å¤±è´¥ï¼š'+(data.error||'æœªçŸ¥é”™è¯¯')); isProcessing.value=false;
        }
      }catch(e){
        const msg=e.response?.data?.error||e.message, code=e.response?.data?.code||'UNKNOWN';
        alert(`æäº¤å¤±è´¥ [${code}]ï¼š${msg}\nå»ºè®®ï¼š${e.response?.data?.suggestion||'è¯·æ£€æŸ¥ç½‘ç»œ'}`);
        isProcessing.value=false;
      }
    }

    /*========== è½®è¯¢ç»“æœ ==========*/
    function queryResult(){
      const t=setInterval(async()=>{
        try{
          const {data}=await axios.get(`/api/hunyuan3d/query/${jobId.value}`);
          if(!data.success){status.value='FAIL'; errorMessage.value=data.error; isProcessing.value=false; clearInterval(t); return;}
          status.value=data.status;
          if(data.status==='DONE'){clearInterval(t); progress.value=100; resultFiles.value=data.resultFiles; isProcessing.value=false;}
          else if(data.status==='FAIL'){clearInterval(t); errorMessage.value=data.errorMessage; isProcessing.value=false;}
          else{progress.value=Math.min(progress.value+12,85);}
        }catch(e){console.error(e);}
      },3500);
    }

    return{ prompt,imageFile,imagePreview,imageError,jobId,status,errorMessage,resultFiles,isProcessing,progress,
            canSubmit,statusText,handleImage,clearImage,submitJob };
  }
}).mount('#app');
</script>
</body>
</html>
